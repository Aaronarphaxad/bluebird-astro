---
import { Image } from 'astro:assets';
import projectsData from '../content/projects.json';
import axiomzurichImg from '@/assets/images/featured-projects/axiomzurich.webp';
import advancedapsImg from '@/assets/images/featured-projects/advancedaps.webp';
import elimunowwImg from '@/assets/images/featured-projects/elimunoww.webp';
import neyneyskitchenImg from '@/assets/images/featured-projects/neyneyskitchen.webp';
import mwsGarageDoorImg from '@/assets/images/featured-projects/mws-garage-door.webp';

const projectImageMap: Record<string, typeof axiomzurichImg> = {
	'axiom-zurich': axiomzurichImg,
	'advancedaps': advancedapsImg,
	'elimu-international': elimunowwImg,
	'ney-neys-kitchen': neyneyskitchenImg,
	'jason-garage-doors': mwsGarageDoorImg,
};
---

<section class="projects-section relative py-16 sm:py-20 md:py-24 bg-bg" aria-label="Featured projects">
	<div class="max-w-5xl mx-auto px-4 sm:px-6 md:px-12">
		<div class="text-center mb-10 sm:mb-12">
			<p class="font-body text-section-tiny font-medium text-textMuted mb-3">
				Featured projects
			</p>
			<h2 class="font-headline text-section-header font-medium text-text mb-1">
				Recent work we're proud of
			</h2>
			<p class="font-body text-section-subheading font-medium text-textMuted max-w-md mx-auto">
				Fast, conversion-focused websites and web applications.
			</p>
		</div>

		<!-- Carousel: one project at a time, arrows -->
		<div class="projects-carousel relative" data-projects-carousel>
			<div class="overflow-hidden">
				{projectsData.map((project, index) => {
					const img = projectImageMap[project.id];
					return (
						<div
							class="projects-carousel-slide w-full"
							data-carousel-slide
							data-index={index}
							role="tabpanel"
							aria-hidden={index !== 0}
							aria-label={`Project ${index + 1} of ${projectsData.length}`}
						>
							<article class="group w-full rounded-[28px] bg-white border border-black/5 shadow-[0_1px_0_rgba(0,0,0,0.04)] hover:shadow-[0_14px_38px_rgba(0,0,0,0.10)] transition-shadow duration-300 overflow-hidden">
								<div class="flex items-start justify-between gap-6 px-6 sm:px-7 pt-6 sm:pt-7">
									<div class="min-w-0">
										<h3 class="font-headline text-xl sm:text-2xl font-semibold text-text truncate">
											{project.title}
										</h3>
										{project.summary ? (
											<p class="mt-2 text-sm text-textMuted leading-relaxed line-clamp-2">
												{project.summary}
											</p>
										) : null}
										{project.tags?.length ? (
											<ul class="mt-3 flex flex-wrap gap-2" aria-label="Project tags">
												{project.tags.map((tag) => (
													<li class="inline-flex items-center px-3 py-1 rounded-full bg-black/5 text-text text-xs sm:text-sm">
														{tag}
													</li>
												))}
											</ul>
										) : null}
									</div>
									{project.viewUrl ? (
										<a
											href={project.viewUrl}
											target="_blank"
											rel="noopener noreferrer"
											class="inline-flex items-center gap-2 rounded-full bg-black/5 px-4 py-2 text-sm text-text hover:bg-black/10 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-white"
											aria-label={`View ${project.title}`}
										>
											<span>View</span>
											<span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-white/70 group-hover:bg-white transition-colors">
												<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
													<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
												</svg>
											</span>
										</a>
									) : null}
								</div>
								{img ? (
									<div class="px-6 sm:px-7 pb-6 sm:pb-7">
										<div class="mt-5 rounded-[22px] overflow-hidden ring-1 ring-black/5 bg-black/[0.02]">
											<Image
												src={img}
												alt={`${project.title} â€” project`}
												width={1920}
												height={1080}
												class="w-full h-auto block transition-transform duration-500 ease-out group-hover:scale-[1.02]"
												loading={index < 2 ? 'eager' : 'lazy'}
											/>
										</div>
									</div>
								) : null}
							</article>
						</div>
					);
				})}
			</div>

			<!-- Arrows -->
			{projectsData.length > 1 && (
				<>
					<button
						type="button"
						class="projects-carousel-prev absolute left-0 top-1/2 -translate-y-1/2 -translate-x-2 sm:-translate-x-4 md:translate-x-0 md:-left-12 w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-white border border-black/10 shadow-md flex items-center justify-center text-text hover:bg-black/5 hover:border-black/15 transition-colors duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none z-10"
						aria-label="Previous project"
						data-carousel-prev
					>
						<svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
						</svg>
					</button>
					<button
						type="button"
						class="projects-carousel-next absolute right-0 top-1/2 -translate-y-1/2 translate-x-2 sm:translate-x-4 md:translate-x-0 md:-right-12 w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-white border border-black/10 shadow-md flex items-center justify-center text-text hover:bg-black/5 hover:border-black/15 transition-colors duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none z-10"
						aria-label="Next project"
						data-carousel-next
					>
						<svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
						</svg>
					</button>
				</>
			)}

			<!-- Counter / dots -->
			{projectsData.length > 1 && (
				<div class="flex justify-center gap-2 mt-6" role="tablist" aria-label="Project slides">
					{projectsData.map((_, index) => (
						<button
							type="button"
							class="w-2 h-2 rounded-full transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2"
							class:list={[
								index === 0 ? 'bg-text' : 'bg-black/20 hover:bg-black/30',
							]}
							aria-label={`Go to project ${index + 1}`}
							aria-selected={index === 0}
							role="tab"
							data-carousel-dot
							data-index={index}
						/>
					))}
				</div>
			)}
		</div>
	</div>
</section>

<script>
	function initCarousel() {
		const carousel = document.querySelector('[data-projects-carousel]');
		const slides = document.querySelectorAll('[data-carousel-slide]');
		const prevBtn = document.querySelector('[data-carousel-prev]');
		const nextBtn = document.querySelector('[data-carousel-next]');
		const dots = document.querySelectorAll('[data-carousel-dot]');

		if (!carousel || slides.length === 0) return;

		let index = 0;
		const total = slides.length;

		function goTo(i: number) {
			index = ((i % total) + total) % total;
			slides.forEach((slide, i) => {
				const el = slide as HTMLElement;
				const isActive = i === index;
				el.style.display = isActive ? 'block' : 'none';
				el.setAttribute('aria-hidden', String(!isActive));
			});
			dots.forEach((dot, i) => {
				dot.setAttribute('aria-selected', i === index ? 'true' : 'false');
				(dot as HTMLElement).classList.toggle('bg-text', i === index);
				(dot as HTMLElement).classList.toggle('bg-black/20', i !== index);
			});
			if (prevBtn) (prevBtn as HTMLButtonElement).disabled = index === 0;
			if (nextBtn) (nextBtn as HTMLButtonElement).disabled = index === total - 1;
		}

		prevBtn?.addEventListener('click', () => goTo(index - 1));
		nextBtn?.addEventListener('click', () => goTo(index + 1));
		dots.forEach((dot, i) => {
			dot.addEventListener('click', () => goTo(i));
		});

		goTo(0);
	}

	if (typeof document !== 'undefined') {
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', initCarousel);
		} else {
			initCarousel();
		}
	}
</script>

<style>
	.projects-carousel-slide {
		display: none;
		opacity: 0;
		transition: opacity 0.35s ease-out;
	}
	.projects-carousel-slide[data-index="0"] {
		display: block;
	}
	.projects-carousel-slide[aria-hidden="false"] {
		opacity: 1;
	}
</style>
